@using time_trace.Components
@using System.Diagnostics
@using System.Text.Json
@model time_trace.Models.Schedule
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = Model.Name;
    var requestToken = Antiforgery.GetAndStoreTokens(Context).RequestToken;
    string? userName = (string?) ViewData["userName"];

    HashSet<DateTime> InitialUserTimes = new();
    Dictionary<DateTime, HashSet<String>> InitialAllTimes = new();

    var userSchedule = Model.UserSchedules.FirstOrDefault(u => u.User.UserName == userName);

    if (userSchedule != null)
    {
        InitialUserTimes.UnionWith(userSchedule.TimeSlots.Select(t => t.DateTime));

        foreach (var timeSlot in Model.UserSchedules.SelectMany(us => us.TimeSlots))
        {
            if (!InitialAllTimes.ContainsKey(timeSlot.DateTime))
            {
                InitialAllTimes.Add(timeSlot.DateTime, new HashSet<String>());
            }
            InitialAllTimes[timeSlot.DateTime].Add(timeSlot.UserSchedule.User.UserName);
        }
    }

    // Debug.WriteLine($"INITIAL USER TIMES: [{string.Join(" | ", InitialUserTimes)}]");
    // Debug.WriteLine($"OTHER USER TIMES: [{string.Join(" | ", InitialAllTimes.Values.SelectMany(h => h))}]");

    var DateDisplayArgs = JsonSerializer.Serialize(new {
        user = userName,
        initialUserTimes = InitialUserTimes.Select(t => new DateTimeOffset(t).ToUnixTimeMilliseconds()),
        initialAllTimes = InitialAllTimes,
        requestToken = requestToken,
        postDateApi = ViewData["postDateApi"],
    });

    var ShareCodeArgs = JsonSerializer.Serialize(new
    {
        sharecode = ViewData["ShareURL"]
    });
}

<div class="text-center">
    
    <div data-react-component="DateDisplay" data-args="@DateDisplayArgs"></div>

    @if(userName == Model.Owner.UserName)
    {
            <div data-react-component="ShareCode" data-args="@ShareCodeArgs"></div>
    }

</>
